version: '3.8'

services:
  vibevoice-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: vibevoice-api:latest
    container_name: vibevoice-api
    
    # GPU support
    # Option 1: Use specific GPU (default - GPU 0)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['3']  # Use GPU 0 only
              # device_ids: ['0', '1']  # Use GPUs 0 and 1
              capabilities: [gpu]
    
    # Option 2: Use all GPUs - uncomment and modify as needed
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    
    # Port mapping
    ports:
      - "${API_PORT:-8001}:8001"
    
    # Environment variables from .env file
    env_file:
      - .env
    
    # Override VOICES_DIR for container (always use /app/voices inside container)
    # The host path is used for volume mounting, but inside container it's always /app/voices
    environment:
      - VOICES_DIR=/app/voices
    
    # Volume mounts
    volumes:
      # Mount voices directory
      - ${VOICES_DIR:-./demo/voices}:/app/voices:ro
      # Mount HuggingFace cache (optional, for faster model loading)
      - ${HF_CACHE_DIR:-~/.cache/huggingface}:/root/.cache/huggingface:rw
      # Mount models directory (optional)
      - ${MODELS_DIR:-./models}:/app/models:rw
    
    # Restart policy
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

